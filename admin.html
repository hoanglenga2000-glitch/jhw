<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ€»æ§å° | æ™ºæ…§å®¶æ•™æ¡¥</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* --- æ——èˆ°çº§æ·±è‰²ç³»ç»Ÿ --- */
        :root { --primary: #6366F1; --accent: #F43F5E; --bg-dark: #0F172A; --bg-card: #1E293B; --text: #F8FAFC; --text-gray: #94A3B8; --border: rgba(255,255,255,0.08); }
        * { margin:0; padding:0; box-sizing:border-box; font-family:sans-serif; }
        body { background: var(--bg-dark); color: var(--text); height: 100vh; display:flex; overflow:hidden; }
        .sidebar { width: 240px; background: rgba(15, 23, 42, 0.95); border-right: 1px solid var(--border); padding: 25px; display:flex; flex-direction:column; overflow-y: auto; }
        .logo { font-size: 1.2rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; color: #fff; }
        .nav-item { padding: 12px 20px; color: var(--text-gray); cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition:0.3s; font-weight:500; }
        .nav-item.active { background: linear-gradient(90deg, var(--primary), #818CF8); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .view { display: none; animation: fadeIn 0.4s ease; } .view.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); position: relative; }
        .stat-val { font-size: 2rem; font-weight: 800; margin-top: 10px; }
        .stat-label { color: var(--text-gray); font-size: 0.9rem; }
        
        /* âœ¨âœ¨âœ¨ [æ–°å¢] å›¾è¡¨åŒºåŸŸæ ·å¼ âœ¨âœ¨âœ¨ */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; height: 400px; }
        
        /* åˆ—è¡¨é€šç”¨ */
        .data-list { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .list-header { background: rgba(255,255,255,0.03); padding: 15px 20px; font-weight: bold; color: var(--text-gray); display: grid; gap: 10px; border-bottom: 1px solid var(--border); }
        .list-item { padding: 20px; border-bottom: 1px solid var(--border); display: grid; gap: 10px; align-items: center; transition: 0.2s; }
        .list-item:hover { background: rgba(255,255,255,0.02); }
        .btn { padding: 6px 15px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 0.85rem; margin-right: 5px; }
        .btn-green { background: #10B981; } .btn-red { background: #EF4444; } .btn-gray { background: #64748B; } .btn-blue { background: #3B82F6; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background: #334155; color: #cbd5e1; }
        .form-input { width: 100%; padding: 10px; background: #0F172A; border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #1E293B; border: 1px solid var(--border); color: #94A3B8; padding: 8px 20px; cursor: pointer; border-radius: 20px; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜æ€»æ§</div>
        <div class="nav-item active" onclick="switchView('dashboard', this)">æ•°æ®æ¦‚è§ˆ</div>
        
        <div style="font-size:0.8rem; color:#64748B; margin:15px 20px 5px;">å®¡æ ¸ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="switchView('audit-tutor', this)">æ•™å‘˜å…¥é©»</div>
        <div class="nav-item" onclick="switchView('audit-res', this)">èµ„æ–™ä¸Šä¼ </div>
        <div class="nav-item" onclick="switchView('audit-withdraw', this)">è´¢åŠ¡æç°</div>
        <div class="nav-item" onclick="switchView('audit-refund', this)">å”®åé€€æ¬¾</div>
        
        <div style="font-size:0.8rem; color:#64748B; margin:15px 20px 5px;">è¿è¥ç®¡ç†</div>
        <div class="nav-item" onclick="switchView('user-manage', this)">ç”¨æˆ·ç®¡ç†</div>
        <div class="nav-item" onclick="switchView('content-manage', this)">å†…å®¹è¯„ä»·</div>
        <div class="nav-item" onclick="switchView('marketing', this)">è¥é”€ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="switchView('notices', this)">å…¬å‘Šå‘å¸ƒ</div>
        <div class="nav-item" onclick="switchView('cs-manage', this)">å®¢æœåé¦ˆ & FAQ</div>
        
        <div class="nav-item" onclick="location.href='index.html'" style="margin-top:auto; color:#EF4444">é€€å‡ºç®¡ç†</div>
    </div>

    <div class="main">
        <div id="view-dashboard" class="view active">
            <h2 style="margin-bottom:30px">å¹³å°è¿è¥é©¾é©¶èˆ±</h2>
            
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">æ€»ç”¨æˆ·æ•°</div><div class="stat-val" id="stUsers">0</div></div>
                <div class="stat-card"><div class="stat-label">å…¥é©»æ•™å‘˜</div><div class="stat-val" id="stTutors">0</div></div>
                <div class="stat-card"><div class="stat-label">å¹³å° GMV (å…ƒ)</div><div class="stat-val" style="color:#FCD34D" id="stGMV">0.00</div></div>
                <div class="stat-card" style="border-color:var(--primary)"><div class="stat-label">å¾…åŠäº‹é¡¹</div><div class="stat-val" style="color:var(--primary)" id="stPending">0</div></div>
            </div>

            <div class="charts-row">
                <div class="chart-box" id="chartTrend"></div>
                <div class="chart-box" id="chartPie"></div>
            </div>
        </div>

        <div id="view-audit-tutor" class="view">
            <h2 style="margin-bottom:20px">æ•™å‘˜å…¥é©»å®¡æ ¸</h2>
            <div class="data-list">
                <div class="list-header" style="grid-template-columns: 2fr 2fr 1fr 1fr 2fr;"><span>å§“å/æ‰‹æœº</span><span>å­¦æ ¡/ä¸“ä¸š</span><span>è¯ä»¶æ ¸éªŒ</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div>
                <div id="tutorList"></div>
            </div>
        </div>
        
        <div id="view-audit-res" class="view"><h2 style="margin-bottom:20px">èµ„æ–™ä¸Šä¼ å®¡æ ¸</h2><div class="data-list"><div class="list-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 2fr;"><span>æ ‡é¢˜</span><span>ç±»å‹</span><span>ä¸Šä¼ è€…</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div><div id="resList"></div></div></div>
        <div id="view-audit-withdraw" class="view"><h2 style="margin-bottom:20px">æç°ç”³è¯·å®¡æ ¸</h2><div class="data-list"><div class="list-header" style="grid-template-columns: 1fr 1fr 2fr 1fr 2fr;"><span>ç”³è¯·äºº</span><span>é‡‘é¢</span><span>æ”¶æ¬¾ä¿¡æ¯</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div><div id="withdrawList"></div></div></div>
        <div id="view-audit-refund" class="view"><h2 style="margin-bottom:20px">å”®åé€€æ¬¾å¤„ç†</h2><div class="data-list"><div class="list-header" style="grid-template-columns: 1fr 2fr 1fr 1fr 2fr;"><span>ç”³è¯·äºº</span><span>ç†ç”±/è€å¸ˆ</span><span>é‡‘é¢</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div><div id="refundList"></div></div></div>

        <div id="view-user-manage" class="view"><h2 style="margin-bottom:20px">ç”¨æˆ·ä¸è´¦å·ç®¡ç†</h2><div class="tab-bar"><button class="tab-btn active" onclick="loadUsers('student', this)">å­¦ç”Ÿåˆ—è¡¨</button><button class="tab-btn" onclick="loadUsers('teacher', this)">æ•™å‘˜åˆ—è¡¨</button></div><div class="data-list"><div class="list-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 2fr;"><span>ç”¨æˆ·</span><span>æ‰‹æœºå·</span><span>ä½™é¢</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div><div id="userList"></div></div></div>
        <div id="view-content-manage" class="view"><h2 style="margin-bottom:20px">è¯„ä»·ç®¡ç†</h2><div class="data-list"><div class="list-header" style="grid-template-columns: 1fr 1fr 1fr 3fr 1fr;"><span>ç”¨æˆ·</span><span>è¯„ä»·æ•™å‘˜</span><span>è¯„åˆ†</span><span>å†…å®¹</span><span>æ“ä½œ</span></div><div id="reviewList"></div></div></div>
        <div id="view-marketing" class="view"><h2 style="margin-bottom:20px">ä¼˜æƒ åˆ¸ç®¡ç†</h2><div style="background:var(--bg-card); padding:20px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px;"><h3 style="margin-bottom:15px">å…¨å‘˜æ™®æƒ </h3><p style="color:gray; margin-bottom:15px;">å‘æ‰€æœ‰æ³¨å†Œç”¨æˆ·å‘æ”¾ä¼˜æƒ åˆ¸ (æ‹‰æ–°/ä¿ƒæ´»)</p><div style="display:flex; gap:10px;"><select id="couponTemplate" class="form-input" style="margin:0; flex:1;"></select><button class="btn btn-green" onclick="issueCoupon()">ä¸€é”®å‘æ”¾</button></div></div></div>
        
        <div id="view-notices" class="view"><h2 style="margin-bottom:20px">ç³»ç»Ÿå…¬å‘Šå‘å¸ƒ</h2><div style="background:var(--bg-card); padding:30px; border-radius:16px; border:1px solid var(--border); margin-bottom:30px;"><input type="text" id="noticeTitle" class="form-input" placeholder="å…¬å‘Šæ ‡é¢˜ (å¦‚ï¼šç³»ç»Ÿç»´æŠ¤é€šçŸ¥)" style="margin-bottom:15px;"><textarea id="noticeContent" class="form-input" rows="4" placeholder="å…¬å‘Šæ­£æ–‡å†…å®¹..." style="margin-bottom:15px;"></textarea><div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;"><input type="checkbox" id="pushNotice" style="width:20px; height:20px;"> <label for="pushNotice" style="color:var(--text-gray)">åŒæ—¶æ¨é€åˆ°æ‰€æœ‰ç”¨æˆ·çš„æ¶ˆæ¯ç®± (å¼ºæé†’)</label></div><button class="btn btn-blue" onclick="pubNotice()">ğŸš€ å‘å¸ƒå…¬å‘Š</button></div><h3 style="margin-bottom:20px">å†å²å…¬å‘Š</h3><div class="data-list"><div class="list-header" style="grid-template-columns: 3fr 1fr 1fr;"><span>æ ‡é¢˜</span><span>å‘å¸ƒæ—¶é—´</span><span>æ“ä½œ</span></div><div id="noticeList"></div></div></div>

        <div id="view-cs-manage" class="view"><h2 style="margin-bottom:20px">å®¢æœä¸­å¿ƒç®¡ç†</h2><div class="tab-bar"><button class="tab-btn active" onclick="loadFeedbacks(this)">ç”¨æˆ·åé¦ˆ</button><button class="tab-btn" onclick="loadFaqs(this)">FAQ å¸¸è§é—®é¢˜</button></div><div id="cs-feedback-box"><div class="data-list"><div class="list-header" style="grid-template-columns: 1fr 3fr 1fr 1fr;"><span>è”ç³»æ–¹å¼</span><span>åé¦ˆå†…å®¹</span><span>æ—¶é—´</span><span>æ“ä½œ</span></div><div id="feedbackList"></div></div></div><div id="cs-faq-box" style="display:none;"><div style="background:var(--bg-card); padding:20px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px;"><h3 style="margin-bottom:15px">æ·»åŠ å¸¸è§é—®é¢˜</h3><input type="text" id="faqQ" class="form-input" placeholder="é—®é¢˜ (Question)" style="margin-bottom:10px;"><textarea id="faqA" class="form-input" rows="3" placeholder="å›ç­” (Answer)" style="margin-bottom:10px;"></textarea><button class="btn btn-green" onclick="addFaq()">æ·»åŠ </button></div><div class="data-list"><div class="list-header" style="grid-template-columns: 3fr 1fr;"><span>é—®é¢˜</span><span>æ“ä½œ</span></div><div id="faqAdminList"></div></div></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { 
            loadStats(); 
            renderCharts(); // âœ¨ åˆå§‹åŒ–å›¾è¡¨
            loadTutors(); loadResources(); loadWithdrawals(); loadRefunds(); loadUsers('student'); loadReviews(); loadCoupons(); loadNotices(); loadFeedbacks(); 
        });

        function switchView(id, btn) {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            btn.classList.add('active');
            // åˆ‡æ¢å›æ¦‚è§ˆæ—¶é‡ç»˜å›¾è¡¨ï¼Œé˜²æ­¢å°ºå¯¸å¼‚å¸¸
            if(id === 'dashboard') setTimeout(renderCharts, 100);
            
            if(id==='user-manage') loadUsers('student');
            if(id==='content-manage') loadReviews();
            if(id==='marketing') loadCoupons();
            if(id==='notices') loadNotices();
            if(id==='cs-manage') loadFeedbacks();
        }

        // âœ¨âœ¨âœ¨ [æ–°å¢] æ¸²æŸ“å›¾è¡¨é€»è¾‘ âœ¨âœ¨âœ¨
        function renderCharts() {
            fetch('api/admin_api.php?action=get_chart_data').then(r=>r.json()).then(res => {
                if(res.status === 'success') {
                    // 1. è¶‹åŠ¿æŠ˜çº¿å›¾
                    let chartTrend = echarts.init(document.getElementById('chartTrend'));
                    let optionTrend = {
                        title: { text: 'è¿‘7å¤©è®¢å•èµ°åŠ¿', textStyle: { color: '#fff' } },
                        tooltip: { trigger: 'axis' },
                        grid: { top: 60, bottom: 40, left: 40, right: 40 },
                        xAxis: { type: 'category', data: res.trend.dates, axisLabel: { color: '#94A3B8' } },
                        yAxis: { type: 'value', axisLabel: { color: '#94A3B8' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } } },
                        series: [{ data: res.trend.counts, type: 'line', smooth: true, color: '#6366F1', areaStyle: { color: 'rgba(99, 102, 241, 0.2)' } }]
                    };
                    chartTrend.setOption(optionTrend);

                    // 2. çƒ­é—¨ç§‘ç›®é¥¼å›¾
                    let chartPie = echarts.init(document.getElementById('chartPie'));
                    let optionPie = {
                        title: { text: 'çƒ­é—¨ç§‘ç›® TOP 5', textStyle: { color: '#fff' } },
                        tooltip: { trigger: 'item' },
                        legend: { bottom: '0%', textStyle: { color: '#fff' } },
                        series: [{
                            name: 'ç§‘ç›®', type: 'pie', radius: ['40%', '70%'],
                            itemStyle: { borderRadius: 10, borderColor: '#1E293B', borderWidth: 2 },
                            label: { show: false },
                            data: res.pie
                        }]
                    };
                    chartPie.setOption(optionPie);
                    
                    // å“åº”çª—å£å¤§å°å˜åŒ–
                    window.onresize = function() { chartTrend.resize(); chartPie.resize(); };
                }
            });
        }

        // ... ä»¥ä¸‹åŸæœ‰é€»è¾‘ä¿æŒä¸å˜ (ä»ä½ çš„åŸæ–‡ä»¶ä¸­å¤åˆ¶) ...
        function loadStats(){fetch('api/admin_api.php?action=get_stats').then(r=>r.json()).then(d=>{document.getElementById('stUsers').innerText=d.users;document.getElementById('stTutors').innerText=d.tutors;document.getElementById('stOrders').innerText=d.orders;document.getElementById('stPending').innerText=d.pending; if(d.gmv) document.getElementById('stGMV').innerText=d.gmv;});}
        function loadTutors() { fetch('api/admin_api.php?action=get_pending_tutors').then(r=>r.json()).then(res=>{ let h = ''; if(res.data.length===0) h='<div style="padding:20px;text-align:center;color:#666">æš‚æ— å¾…å®¡æ ¸æ•™å‘˜</div>'; else res.data.forEach(t => { let certHtml = t.cert_img ? `<a href="assets/${t.cert_img}" target="_blank" style="color:#6366F1;text-decoration:underline">æŸ¥çœ‹è¯ä»¶</a>` : '<span style="color:red">æœªä¸Šä¼ </span>'; h += `<div class="list-item" style="grid-template-columns: 2fr 2fr 1fr 1fr 2fr;"><div><strong>${t.name}</strong><br><span style="font-size:0.8rem;color:#94A3B8">${t.phone}</span></div><div>${t.school}<br><span style="font-size:0.8rem;color:#94A3B8">${t.major}</span></div><div>${certHtml}</div><div><span class="tag" style="color:#F59E0B">å¾…å®¡æ ¸</span></div><div><button class="btn btn-green" onclick="auditTutor(${t.id}, 'å·²é€šè¿‡')">é€šè¿‡</button><button class="btn btn-red" onclick="auditTutor(${t.id}, 'å·²æ‹’ç»')">æ‹’ç»</button></div></div>`; }); document.getElementById('tutorList').innerHTML = h; }); }
        function loadResources(){fetch('api/admin_api.php?action=get_pending_resources').then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<div style="padding:20px;text-align:center;color:#666">æš‚æ— å¾…å®¡æ ¸èµ„æ–™</div>';else res.data.forEach(r=>{h+=`<div class="list-item" style="grid-template-columns: 2fr 1fr 1fr 1fr 2fr;"><div><a href="uploads/${r.file_path}" target="_blank" style="color:#6366F1">${r.title}</a></div><div>${r.type}</div><div>${r.uploader_phone}</div><div><span class="tag" style="color:#F59E0B">å¾…å®¡æ ¸</span></div><div><button class="btn btn-green" onclick="auditRes(${r.id}, 'å·²é€šè¿‡')">é€šè¿‡</button><button class="btn btn-red" onclick="auditRes(${r.id}, 'å·²æ‹’ç»')">æ‹’ç»</button></div></div>`;});document.getElementById('resList').innerHTML=h;});}
        function loadWithdrawals(){fetch('api/withdraw_api.php?action=admin_get_pending').then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<div style="padding:20px;text-align:center;color:#666">æš‚æ— æç°ç”³è¯·</div>';else res.data.forEach(w=>{h+=`<div class="list-item" style="grid-template-columns: 1fr 1fr 2fr 1fr 2fr;"><div>${w.user_phone}</div><div style="color:#FCD34D; font-weight:bold;">Â¥${w.amount}</div><div style="font-size:0.85rem;">${w.method}<br>${w.account_info}</div><div><span class="tag" style="color:#F59E0B">å¾…å¤„ç†</span></div><div><button class="btn btn-green" onclick="processWithdraw(${w.id}, 'approved')">ç¡®è®¤æ‰“æ¬¾</button><button class="btn btn-red" onclick="processWithdraw(${w.id}, 'rejected')">æ‹’ç»</button></div></div>`;});document.getElementById('withdrawList').innerHTML=h;});}
        function loadRefunds(){fetch('api/admin_api.php?action=get_pending_refunds').then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<div style="padding:20px;text-align:center;color:#666">æš‚æ— å¾…å®¡æ ¸é€€æ¬¾</div>';else res.data.forEach(r=>{h+=`<div class="list-item" style="grid-template-columns: 1fr 2fr 1fr 1fr 2fr;"><div>${r.user_phone}</div><div style="font-size:0.85rem;">ç†ç”±: ${r.reason}<br><span style="color:#666">è€å¸ˆ: ${r.tutor_name}</span></div><div style="color:#EF4444; font-weight:bold;">Â¥${r.amount}</div><div><span class="tag" style="color:#F59E0B">å¾…å¤„ç†</span></div><div><button class="btn btn-green" onclick="processRefund(${r.id}, 'approved')">åŒæ„é€€æ¬¾</button><button class="btn btn-red" onclick="processRefund(${r.id}, 'rejected')">æ‹’ç»</button></div></div>`;});document.getElementById('refundList').innerHTML=h;});}
        function auditTutor(id,s){if(!confirm('ç¡®è®¤æ“ä½œï¼Ÿ'))return;let fd=new FormData();fd.append('id',id);fd.append('status',s);fetch('api/admin_api.php?action=audit_tutor',{method:'POST',body:fd}).then(()=>{alert('æ“ä½œæˆåŠŸ');loadTutors();loadStats();});}
        function auditRes(id,s){if(!confirm('ç¡®è®¤æ“ä½œï¼Ÿ'))return;let fd=new FormData();fd.append('id',id);fd.append('status',s);fetch('api/admin_api.php?action=audit_resource',{method:'POST',body:fd}).then(()=>{alert('æ“ä½œæˆåŠŸ');loadResources();loadStats();});}
        function processWithdraw(id,s){let r='';if(s==='rejected'){r=prompt("è¯·è¾“å…¥æ‹’ç»åŸå› ï¼š");if(!r)return;}else{if(!confirm("ç¡®è®¤å·²é€šè¿‡çº¿ä¸‹è½¬è´¦ï¼Ÿ"))return;}let fd=new FormData();fd.append('id',id);fd.append('status',s);if(r)fd.append('reason',r);fetch('api/withdraw_api.php?action=admin_process',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('æ“ä½œæˆåŠŸ');loadWithdrawals();}else alert(d.message);});}
        function processRefund(id,s){if(!confirm(s==='approved'?'ç¡®è®¤é€€æ¬¾ï¼Ÿ':'ç¡®è®¤æ‹’ç»ï¼Ÿ'))return;let fd=new FormData();fd.append('id',id);fd.append('status',s);fetch('api/admin_api.php?action=process_refund',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('æ“ä½œæˆåŠŸ');loadRefunds();loadStats();}else alert(d.message);});}
        function loadCoupons(){fetch('api/admin_api.php?action=get_coupons').then(r=>r.json()).then(res=>{let s=document.getElementById('couponTemplate');s.innerHTML='';if(res.data)res.data.forEach(c=>{let opt=document.createElement('option');opt.value=c.id;opt.text=`${c.name} (å‡${c.discount})`;s.add(opt);});});}
        function issueCoupon(){if(!confirm('ç¡®å®šå…¨å‘˜å‘æ”¾ï¼Ÿ'))return;let cid=document.getElementById('couponTemplate').value;let fd=new FormData();fd.append('coupon_id',cid);fetch('api/admin_api.php?action=issue_coupon',{method:'POST',body:fd}).then(()=>{alert('å‘æ”¾æˆåŠŸ');});}
        function loadNotices(){fetch('api/admin_api.php?action=get_announcements').then(r=>r.json()).then(res=>{let h='';if(!res.data||res.data.length===0)h='<p style="text-align:center;padding:20px;color:gray">æš‚æ— å…¬å‘Š</p>';else res.data.forEach(n=>{h+=`<div class="list-item" style="grid-template-columns: 3fr 1fr 1fr;"><div>${n.title} ${n.is_pushed==1?'<span class="tag" style="background:#3B82F6">å·²æ¨é€</span>':''}</div><div style="color:gray;font-size:0.9rem">${n.create_time}</div><div><button class="btn btn-red" onclick="delNotice(${n.id})">åˆ é™¤</button></div></div>`;});document.getElementById('noticeList').innerHTML=h;});}
        function pubNotice(){let titleDom=document.getElementById('noticeTitle');let contentDom=document.getElementById('noticeContent');let pushDom=document.getElementById('pushNotice');if(!titleDom||!contentDom)return alert('é”™è¯¯');let t=titleDom.value;let c=contentDom.value;let p=pushDom.checked;if(!t||!c)return alert('å®Œå–„ä¿¡æ¯');if(!confirm('å‘å¸ƒï¼Ÿ'))return;let fd=new FormData();fd.append('type','add');fd.append('title',t);fd.append('content',c);fd.append('push',p);fetch('api/admin_api.php?action=manage_announcement',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert('å‘å¸ƒæˆåŠŸ');titleDom.value='';contentDom.value='';loadNotices();}else alert(d.message);});}
        function delNotice(id){if(confirm('åˆ é™¤ï¼Ÿ'))fetch('api/admin_api.php?action=manage_announcement',{method:'POST',body:objToFd({type:'delete',id:id})}).then(()=>{loadNotices();});}
        function loadFeedbacks(btn){if(btn)switchTab(btn,'cs-feedback-box');fetch('api/admin_api.php?action=get_feedbacks').then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style="text-align:center;padding:20px;color:gray">æš‚æ— åé¦ˆ</p>';else res.data.forEach(f=>{let status=f.status==='unread'?'<span class="tag" style="background:#EF4444;color:white">æœªè¯»</span>':'<span class="tag" style="background:#64748B">å·²è¯»</span>';let act=f.status==='unread'?`<button class="btn btn-blue" onclick="readFeedback(${f.id})">æ ‡è®°å·²è¯»</button>`:'å·²å¤„ç†';h+=`<div class="list-item" style="grid-template-columns: 1fr 3fr 1fr 1fr;"><div>${f.user_contact}</div><div style="font-size:0.9rem;color:white;">${f.content}</div><div style="font-size:0.8rem;color:gray">${f.create_time}</div><div>${act}</div></div>`;});document.getElementById('feedbackList').innerHTML=h;});}
        function loadFaqs(btn){if(btn)switchTab(btn,'cs-faq-box');fetch('api/public_api.php?action=get_faqs').then(r=>r.json()).then(res=>{let h='';res.data.forEach(q=>{h+=`<div class="list-item" style="grid-template-columns: 3fr 1fr;"><div>${q.question}</div><div><button class="btn btn-red" onclick="delFaq(${q.id})">åˆ é™¤</button></div></div>`;});document.getElementById('faqAdminList').innerHTML=h;});}
        function readFeedback(id){fetch('api/admin_api.php?action=read_feedback',{method:'POST',body:objToFd({id:id})}).then(()=>{loadFeedbacks();});}
        function addFaq(){let q=document.getElementById('faqQ').value;let a=document.getElementById('faqA').value;if(!q||!a)return alert('è¯·å¡«å†™å®Œæ•´');fetch('api/admin_api.php?action=manage_faq',{method:'POST',body:objToFd({type:'add',question:q,answer:a})}).then(()=>{document.getElementById('faqQ').value='';document.getElementById('faqA').value='';loadFaqs();});}
        function delFaq(id){if(confirm('åˆ é™¤?'))fetch('api/admin_api.php?action=manage_faq',{method:'POST',body:objToFd({type:'delete',id:id})}).then(()=>{loadFaqs();});}
        function switchTab(btn,boxId){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('cs-feedback-box').style.display='none';document.getElementById('cs-faq-box').style.display='none';document.getElementById(boxId).style.display='block';}
        function objToFd(obj){let fd=new FormData();for(let k in obj)fd.append(k,obj[k]);return fd;}
        let currentUserType='student';
        function loadUsers(type,btn){if(btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}currentUserType=type;fetch(`api/admin_api.php?action=get_all_users&type=${type}`).then(r=>r.json()).then(res=>{let h='';res.data.forEach(u=>{let badge=u.is_banned==1?'<span class="tag" style="background:#EF4444;color:white">å·²å°ç¦</span>':'<span class="tag" style="background:#10B981;color:white">æ­£å¸¸</span>';let act=u.is_banned==1?`<button class="btn btn-green" onclick="toggleBan(${u.id},0)">è§£å°</button>`:`<button class="btn btn-red" onclick="toggleBan(${u.id},1)">å°ç¦</button>`;h+=`<div class="list-item" style="grid-template-columns: 2fr 1fr 1fr 1fr 2fr;"><div>${u.name}</div><div>${u.phone}</div><div style="color:#FCD34D">Â¥${u.balance}</div><div>${badge}</div><div>${act}<button class="btn btn-gray" onclick="resetPwd(${u.id})">é‡ç½®å¯†ç </button></div></div>`;});document.getElementById('userList').innerHTML=h;});}
        function toggleBan(id,s){if(!confirm(s==1?'å°ç¦ï¼Ÿ':'è§£å°ï¼Ÿ'))return;let fd=new FormData();fd.append('type',currentUserType);fd.append('id',id);fd.append('is_banned',s);fetch('api/admin_api.php?action=toggle_ban',{method:'POST',body:fd}).then(()=>{loadUsers(currentUserType);});}
        function resetPwd(id){if(!confirm('é‡ç½®ä¸º123456ï¼Ÿ'))return;let fd=new FormData();fd.append('type',currentUserType);fd.append('id',id);fetch('api/admin_api.php?action=reset_password',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{alert(d.message);});}
        function loadReviews(){fetch('api/admin_api.php?action=get_all_reviews').then(r=>r.json()).then(res=>{let h='';if(res.data.length===0)h='<p style="text-align:center;padding:20px;color:gray">æš‚æ— è¯„ä»·</p>';else res.data.forEach(r=>{h+=`<div class="list-item" style="grid-template-columns: 1fr 1fr 1fr 3fr 1fr;"><div>${r.user_phone}</div><div>${r.tutor_name}</div><div style="color:#F59E0B">${r.rating}æ˜Ÿ</div><div style="font-size:0.85rem;color:gray">${r.content}</div><div><button class="btn btn-red" onclick="delReview(${r.id})">åˆ é™¤</button></div></div>`;});document.getElementById('reviewList').innerHTML=h;});}
        function delReview(id){if(confirm('åˆ é™¤æ­¤è¯„ä»·ï¼Ÿ')){let fd=new FormData();fd.append('id',id);fetch('api/admin_api.php?action=delete_review',{method:'POST',body:fd}).then(()=>{loadReviews();});}}
    </script>
</body>
</html>